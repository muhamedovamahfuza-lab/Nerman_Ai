{% load i18n %}
<header class="sticky top-0 z-50 pt-[25px] pb-6">
    <nav class="container mx-auto px-4">
        <div class="flex items-center justify-between gap-4">
            <!-- Main Navigation Group -->
            <div
                class="bg-slate-100 rounded-[15px] px-8 py-2 flex items-center shadow-lg h-[80px] flex-grow justify-between">
                <!-- Logo -->
                <a href="{% url 'home' %}" class="text-2xl font-bold gradient-text font-orbitron mr-8">
                    NERMAN.AI
                </a>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-1">
                    <a href="{% url 'home' %}" id="nav-home"
                        class="px-5 py-2.5 rounded-full text-sm font-bold transition-all text-slate-900 hover:text-[#157BFF] whitespace-nowrap">
                        Дом
                    </a>
                    <a href="{% url 'home' %}#product" id="nav-product"
                        class="px-5 py-2.5 rounded-full text-sm font-bold transition-all text-slate-900 hover:text-[#157BFF] whitespace-nowrap">
                        О Продукте
                    </a>



                    <a href="{% url 'home' %}#about" id="nav-about"
                        class="px-5 py-2.5 rounded-full text-sm font-bold transition-all text-slate-900 hover:text-[#157BFF] whitespace-nowrap">
                        О Нас
                    </a>

                    {% url 'pricing' as pricing_url %}
                    <a href="{{ pricing_url }}"
                        class="px-5 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap {% if request.path == pricing_url %}bg-gradient-to-r from-[#157BFF] to-[#15488B] text-white shadow-lg{% else %}text-slate-900 hover:text-[#157BFF]{% endif %}">
                        Подписка
                    </a>

                    {% url 'contact' as contact_url %}
                    <a href="{{ contact_url }}"
                        class="px-5 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap {% if request.path == contact_url %}bg-gradient-to-r from-[#157BFF] to-[#15488B] text-white shadow-lg{% else %}text-slate-900 hover:text-[#157BFF]{% endif %}">
                        Поддержка
                    </a>

                    <!-- Language Switcher -->
                    {% get_current_language as LANGUAGE_CODE %}
                    {% get_available_languages as LANGUAGES %}
                    {% get_language_info_list for LANGUAGES as languages %}

                    <div class="relative group ml-1.5">
                        <button id="lang-menu-btn" onclick="toggleLangMenu()"
                            class="px-5 py-2.5 rounded-full text-sm font-bold bg-black text-white hover:bg-gray-800 transition-all flex items-center shadow-lg">
                            <span class="mr-1">
                                {% if LANGUAGE_CODE == 'ru' %}Русский
                                {% elif LANGUAGE_CODE == 'en' %}English
                                {% elif LANGUAGE_CODE == 'uz' %}O'zbek
                                {% else %}{{ LANGUAGE_CODE|upper }}{% endif %}
                            </span>
                            <svg class="w-3 h-3 fill-current" viewBox="0 0 20 20">
                                <path
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" />
                            </svg>
                        </button>

                        <!-- Dropdown -->
                        <div id="lang-dropdown"
                            class="hidden absolute top-full left-0 mt-2 w-40 bg-black rounded-2xl shadow-xl overflow-hidden border border-gray-800 z-50">
                            <form action="{% url 'set_language' %}" method="post" id="lang-form">
                                {% csrf_token %}
                                <input name="next" type="hidden" value="{{ request.path }}">
                                <input name="language" type="hidden" id="lang-input">
                                <div class="py-1">
                                    {% for language in languages %}
                                    <button type="button" onclick="submitLanguage('{{ language.code }}')"
                                        class="block w-full text-left px-4 py-3 text-sm font-bold hover:bg-gray-800 transition-colors
                                            {% if language.code == LANGUAGE_CODE %}text-[#157BFF]{% else %}text-white{% endif %}">
                                        {{ language.name_local }}
                                    </button>
                                    {% endfor %}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auth Buttons -->
            <div class="hidden md:flex items-center space-x-4">
                {% if user.is_authenticated %}
                <a href="{% url 'dashboard' %}"
                    class="px-6 py-2.5 bg-gradient-to-r from-[#157BFF] to-[#15488B] text-white rounded-full font-bold hover:shadow-lg transition-all">
                    {{ user.first_name|default:user.email }}
                </a>
                <a href="{% url 'logout' %}"
                    class="px-6 py-2.5 text-slate-500 font-bold hover:text-[#157BFF] transition-all">Выйти</a>
                {% else %}
                <div
                    class="flex items-center justify-between bg-slate-100 rounded-[15px] p-2 w-[460px] h-[80px] shadow-lg">
                    <a href="{% url 'login' %}"
                        class="flex-1 flex items-center justify-center h-full rounded-[12px] text-[#157BFF] font-bold text-lg hover:text-[#15488B] transition-all">
                        Войти
                    </a>
                    <a href="{% url 'register' %}"
                        class="flex-1 flex items-center justify-center h-full bg-[#157BFF] text-white rounded-[12px] font-bold text-lg shadow-md hover:shadow-lg hover:bg-[#15488B] transition-all">
                        Зарегистрироваться
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Mobile Menu Button -->
            <button id="mobile-menu-btn" class="md:hidden text-2xl text-slate-800">
                ☰
            </button>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu"
            class="hidden md:hidden mt-4 pb-4 space-y-2 bg-white rounded-2xl shadow-xl p-4 border border-slate-100">
            <a href="{% url 'home' %}" id="mobile-nav-home"
                class="block px-4 py-2 bg-black text-white rounded-full">Дом</a>
            <a href="{% url 'product' %}" class="block px-4 py-2 bg-black text-white rounded-full">О Продукте</a>
            <a href="{% url 'pricing' %}" class="block px-4 py-2 bg-black text-white rounded-full">Подписка</a>
            <a href="{% url 'faq' %}" class="block px-4 py-2 bg-black text-white rounded-full">FAQ</a>
            <a href="{% url 'blog' %}" class="block px-4 py-2 bg-black text-white rounded-full">Блог</a>
            <a href="{% url 'contact' %}" class="block px-4 py-2 bg-black text-white rounded-full">Поддержка</a>
            <a href="{% url 'about' %}" class="block px-4 py-2 bg-black text-white rounded-full">О Нас</a>

            <!-- Mobile Language Switcher -->
            <div class="border-t border-slate-100 my-2 pt-2 pb-1">
                <p class="text-xs text-slate-500 font-bold mb-2 uppercase px-4">Язык</p>
                <div class="flex space-x-2 px-4">
                    {% get_available_languages as LANGUAGES %}
                    {% get_language_info_list for LANGUAGES as languages %}
                    {% for language in languages %}
                    <button type="button" onclick="submitLanguage('{{ language.code }}')"
                        class="flex-1 py-2 rounded-lg text-sm font-bold text-center transition-all {% if language.code == LANGUAGE_CODE %}bg-[#157BFF] text-white shadow-md{% else %}bg-slate-100 text-slate-600 hover:bg-slate-200{% endif %}">
                        {{ language.code|upper }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% if user.is_authenticated %}
            <a href="{% url 'dashboard' %}"
                class="block px-4 py-2 bg-black text-white rounded-full font-medium">Dashboard</a>
            <a href="{% url 'logout' %}"
                class="block px-4 py-2 bg-slate-100 text-slate-600 rounded-full font-medium">Выйти</a>
            {% else %}
            <div class="flex flex-col space-y-2 pt-2 border-t border-slate-100">
                <a href="{% url 'login' %}"
                    class="block text-center py-2 bg-black text-white rounded-full transition-all">
                    Войти
                </a>
                <a href="{% url 'register' %}"
                    class="block text-center py-2 text-white gradient-bg rounded-full shadow-lg">
                    Зарегистрироваться
                </a>
            </div>
            {% endif %}
        </div>
    </nav>
</header>

<script>
    document.getElementById('mobile-menu-btn').addEventListener('click', function () {
        document.getElementById('mobile-menu').classList.toggle('hidden');
    });

    function toggleLangMenu() {
        const dropdown = document.getElementById('lang-dropdown');
        dropdown.classList.toggle('hidden');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function (event) {
        const btn = document.getElementById('lang-menu-btn');
        const dropdown = document.getElementById('lang-dropdown');
        if (btn && dropdown && !btn.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });

    function submitLanguage(langCode) {
        document.getElementById('lang-input').value = langCode;
        document.getElementById('lang-form').submit();
    }

    // Scroll Spy
    document.addEventListener('DOMContentLoaded', function () {
        const sections = ['home', 'product', 'about', 'team'];
        const navLinks = {
            'home': document.getElementById('nav-home'),
            'product': document.getElementById('nav-product'),
            'about': document.getElementById('nav-about'),
            'team': document.getElementById('nav-team')
        };
        const offset = 150;
        const activeClasses = ['bg-gradient-to-r', 'from-[#157BFF]', 'to-[#15488B]', 'text-white', 'shadow-lg'];
        const inactiveClasses = ['text-slate-900', 'hover:text-[#157BFF]'];

        function updateActiveSection() {
            let currentSection = '';

            // Check sections
            for (const id of sections) {
                const section = document.getElementById(id);
                if (section) {
                    const rect = section.getBoundingClientRect();
                    if (rect.top <= offset && rect.bottom >= offset) {
                        currentSection = id;
                    }
                }
            }

            // Priority: Top of page is always Home
            if (window.scrollY < 100 && document.getElementById('home')) {
                currentSection = 'home';
            }

            // Update Links
            for (const id of sections) {
                const link = navLinks[id];
                if (link) {
                    if (id === currentSection) {
                        link.classList.remove(...inactiveClasses);
                        link.classList.add(...activeClasses);
                    } else {
                        link.classList.remove(...activeClasses);
                        link.classList.add(...inactiveClasses);
                    }
                }
            }
        }

        if (document.getElementById('home') || document.getElementById('product')) {
            window.addEventListener('scroll', updateActiveSection);
            // Initial check
            updateActiveSection();
        }
    });
</script>